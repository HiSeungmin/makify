<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>챌린지 둘러보기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/navbar.css}" />
  <link rel="stylesheet" th:href="@{/css/footer.css}" />
  <link rel="stylesheet" th:href="@{/css/challenges.css}" />
  <link rel="icon" type="image/x-icon" th:href="@{/images/favicon.png}">
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="challenges-container">
  <!-- 헤더 섹션 -->
  <div class="header-section">
    <h1 class="page-title">모든 챌린지</h1>
    <p class="page-subtitle">다양한 챌린지를 찾아보고 새로운 습관을 만들어보세요</p>
  </div>

  <!-- 검색 및 필터 섹션 -->
  <div class="search-filter-section">
    <div class="search-bar">
      <input type="text" id="searchKeyword" class="search-input" placeholder="챌린지 제목이나 설명을 검색하세요..." />
      <select class="filter-select" id="categoryFilter">
        <option value="">전체 카테고리</option>
        <option value="ROUTINE">규칙적인 생활</option>
        <option value="EXERCISE">운동</option>
        <option value="MINDSET">마음챙김</option>
        <option value="EATING_HABITS">식습관</option>
        <option value="HOBBY">취미</option>
        <option value="STUDY">공부</option>
      </select>
      <select class="filter-select" id="statusFilter">
        <option value="">진행 상태</option>
        <option value="NOT_STARTED">모집중</option>
        <option value="IN_PROGRESS">진행중</option>
        <option value="COMPLETED">완료</option>
      </select>
      <select class="filter-select" id="sortFilter">
        <option value="latest">최신순</option>
        <option value="popularity">인기순</option>
        <option value="startDate">시작일순</option>
      </select>
      <button type="button" id="searchBtn" class="search-btn">검색</button>
    </div>
  </div>

  <!-- 검색 결과 상태 -->
  <div id="searchStatus" class="search-status d-none">
    <span id="searchStatusText"></span>
    <button type="button" id="clearSearch" class="clear-search-btn">전체 보기</button>
  </div>

  <!-- 로딩 스피너 -->
  <div id="loadingSpinner" class="loading-spinner d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">챌린지를 검색하는 중...</p>
  </div>

  <!-- 챌린지 그리드 -->
  <div id="challengeList" class="challenges-grid">
    <!-- 서버 렌더링 데이터 -->
    <div class="challenge-card" th:each="challenge : ${challenges}">
      <div class="position-relative">
        <img th:src="@{/images/default-challenge.avif}" class="card-image" alt="챌린지 이미지">
        <div class="card-badges">
          <span class="category-badge" th:text="${challenge.category.description}">카테고리</span>
          <span class="status-badge" 
                th:classappend="${challenge.status.name() == 'NOT_STARTED' ? '모집중' : (challenge.status.name() == 'IN_PROGRESS' ? '진행중' : '완료')}"
                th:text="${challenge.status.description}">모집중</span>
        </div>
      </div>
      
      <div class="card-content">
        <h3 class="card-title" th:text="${challenge.title}">챌린지 제목</h3>
        <p class="card-description" th:text="${challenge.description}">챌린지 설명입니다.</p>
        
        <div class="card-meta">
          <span th:text="${challenge.startDate} + ' ~ ' + ${challenge.endDate}">2025.01.01 ~ 2025.01.31</span>
        </div>

        <div class="card-stats">
          <div class="stat-item">
            <i class="bi bi-people"></i>
            <span th:text="${challenge.participantCount ?: 0} + '명'">0명</span>
          </div>
          <div class="stat-item">
            <i class="bi bi-calendar-check"></i>
            <span>매일</span>
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-label">
            <span class="progress-text">진행률</span>
            <span class="progress-percent">65%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: 65%"></div>
          </div>
        </div>

        <div class="card-footer">
          <div class="participants-info">
            <i class="bi bi-people-fill"></i>
            <span th:text="${challenge.participantCount ?: 0} + '/' + ${challenge.maxParticipants} + '명 참여'">0/50명 참여</span>
          </div>
          <a th:href="@{'/challenges/' + ${challenge.id}}" class="join-btn">
            챌린지 참여
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- 빈 결과 메시지 -->
  <div id="emptyResult" class="empty-result d-none">
    <i class="bi bi-search"></i>
    <h4>검색 결과가 없습니다</h4>
    <p>다른 키워드나 필터로 다시 시도해보세요.</p>
  </div>

  <!-- 페이지네이션 -->
  <div id="pagination" class="pagination-container">
    <!-- JavaScript로 동적 생성 -->
  </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/navbar.js}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    initializeSearch();
    
    const initialPagination = {
      totalPages: parseInt(document.getElementById('totalPages')?.value) || 1,
      currentPage: parseInt(document.getElementById('currentPageHidden')?.value) || 0,
      totalElements: parseInt(document.getElementById('totalElements')?.value) || 0
    };
    
    if (initialPagination.totalPages > 1) {
      renderInitialPagination(initialPagination);
    }
  });

  // 검색 관련 변수
  let currentPage = 0;
  let currentKeyword = '';
  let currentCategory = '';
  let currentStatus = '';
  let currentSort = 'latest';

  function initializeSearch() {
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearch');
    const searchKeyword = document.getElementById('searchKeyword');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');

    // 검색 버튼으로 모든 검색/필터 처리
    searchBtn.addEventListener('click', performSearch);
    clearSearchBtn.addEventListener('click', clearSearch);
    
    // 엔터키 검색
    searchKeyword.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // 필터 변경시 자동 검색
    categoryFilter.addEventListener('change', performSearch);
    statusFilter.addEventListener('change', performSearch);
    sortFilter.addEventListener('change', performSearch);
  }

  async function performSearch(page) {
    if (typeof page === 'object' || page === undefined) {
      page = 0;
    }
    
    const keyword = document.getElementById('searchKeyword').value.trim();
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    const sort = document.getElementById('sortFilter').value;

    currentPage = page;
    currentKeyword = keyword;
    currentCategory = category;
    currentStatus = status;
    currentSort = sort;

    showLoading(true);
    
    try {
      const params = new URLSearchParams();
      if (keyword) params.append('keyword', keyword);
      if (category) params.append('category', category);
      if (status) params.append('status', status);
      params.append('sortBy', sort);
      params.append('page', page);
      params.append('size', 12);

      const response = await fetch(`/api/challenges/search?${params}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      renderChallenges(data.content || []);
      renderPagination(data);
      updateSearchStatus(keyword, category, status, data.totalElements || 0);

    } catch (error) {
      console.error('검색 중 오류 발생:', error);
      showError('검색 중 오류가 발생했습니다.');
      renderChallenges([]);
      document.getElementById('emptyResult').classList.remove('d-none');
    } finally {
      showLoading(false);
    }
  }

  function renderChallenges(challenges) {
    const challengeList = document.getElementById('challengeList');
    const emptyResult = document.getElementById('emptyResult');

    if (challenges.length === 0) {
      challengeList.innerHTML = '';
      emptyResult.classList.remove('d-none');
      return;
    }

    emptyResult.classList.add('d-none');
    
    challengeList.innerHTML = challenges.map(challenge => `
      <div class="challenge-card">
        <div class="position-relative">
          <img src="/images/default-challenge.avif" class="card-image" alt="챌린지 이미지">
          <div class="card-badges">
            <span class="category-badge">${challenge.categoryDisplayName}</span>
            <span class="status-badge ${getStatusClassName(challenge.status)}">${getStatusDisplayName(challenge.status)}</span>
          </div>
        </div>
        
        <div class="card-content">
          <h3 class="card-title">${challenge.title}</h3>
          <p class="card-description">${challenge.description}</p>
          
          <div class="card-meta">
            <span>${challenge.startDate} ~ ${challenge.endDate}</span>
          </div>

          <div class="card-stats">
            <div class="stat-item">
              <i class="bi bi-people"></i>
              <span>${challenge.currentParticipants || 0}명</span>
            </div>
            <div class="stat-item">
              <i class="bi bi-calendar-check"></i>
              <span>매일</span>
            </div>
          </div>

          <div class="progress-section">
            <div class="progress-label">
              <span class="progress-text">진행률</span>
              <span class="progress-percent">65%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 65%"></div>
            </div>
          </div>

          <div class="card-footer">
            <div class="participants-info">
              <i class="bi bi-people-fill"></i>
              <span>${challenge.currentParticipants || 0}/${challenge.maxParticipants}명 참여</span>
            </div>
            <a href="/challenges/${challenge.id}" class="join-btn">
              챌린지 참여
            </a>
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    const totalPages = data.totalPages;
    const currentPage = data.currentPage;

    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let paginationHTML = '<div class="pagination">';
    
    if (currentPage > 0) {
      paginationHTML += `<a href="#" class="page-btn" data-page="${currentPage - 1}">‹</a>`;
    }

    const start = Math.max(0, currentPage - 2);
    const end = Math.min(totalPages, currentPage + 3);

    for (let i = start; i < end; i++) {
      paginationHTML += `<a href="#" class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i + 1}</a>`;
    }

    if (currentPage < totalPages - 1) {
      paginationHTML += `<a href="#" class="page-btn" data-page="${currentPage + 1}">›</a>`;
    }

    paginationHTML += '</div>';
    pagination.innerHTML = paginationHTML;
    
    pagination.querySelectorAll('.page-btn').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = parseInt(this.getAttribute('data-page'));
        if (!isNaN(page)) {
          performSearch(page);
        }
      });
    });
  }

  function renderInitialPagination(paginationData) {
    renderPagination(paginationData);
    
    const pagination = document.getElementById('pagination');
    pagination.querySelectorAll('.page-btn').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = parseInt(this.getAttribute('data-page'));
        if (!isNaN(page)) {
          window.location.href = `/challenges?page=${page}&size=12`;
        }
      });
    });
  }

  function updateSearchStatus(keyword, category, status, totalCount) {
    const searchStatus = document.getElementById('searchStatus');
    const searchStatusText = document.getElementById('searchStatusText');

    if (keyword || category || status) {
      let statusText = `검색 결과 ${totalCount}개`;
      if (keyword) statusText += ` (키워드: "${keyword}")`;
      if (category) statusText += ` (카테고리: ${getCategoryDisplayName(category)})`;
      if (status) statusText += ` (상태: ${getStatusDisplayName(status)})`;
      
      searchStatusText.textContent = statusText;
      searchStatus.classList.remove('d-none');
    } else {
      searchStatus.classList.add('d-none');
    }
  }

  function clearSearch() {
    document.getElementById('searchKeyword').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortFilter').value = 'latest';
    window.location.href = '/challenges';
  }

  function showLoading(show) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const challengeList = document.getElementById('challengeList');
    
    if (show) {
      loadingSpinner.classList.remove('d-none');
      challengeList.style.opacity = '0.5';
    } else {
      loadingSpinner.classList.add('d-none');
      challengeList.style.opacity = '1';
    }
  }

  function showError(message) {
    alert(message);
  }

  function getStatusClassName(status) {
    switch (status) {
      case 'NOT_STARTED': return '모집중';
      case 'IN_PROGRESS': return '진행중';
      case 'COMPLETED': return '완료';
      default: return '모집중';
    }
  }

  function getStatusDisplayName(status) {
    switch (status) {
      case 'NOT_STARTED': return '모집중';
      case 'IN_PROGRESS': return '진행중';
      case 'COMPLETED': return '완료';
      default: return '알 수 없음';
    }
  }

  function getCategoryDisplayName(category) {
    const categoryMap = {
      'ROUTINE': '규칙적인 생활',
      'EXERCISE': '운동',
      'MINDSET': '마음챙김',
      'EATING_HABITS': '식습관',
      'HOBBY': '취미',
      'STUDY': '공부'
    };
    return categoryMap[category] || category;
  }
</script>

<!-- 페이지네이션 정보를 hidden input으로 전달 -->
<input type="hidden" id="totalPages" th:value="${totalPages ?: 1}">
<input type="hidden" id="totalElements" th:value="${totalElements ?: 0}">
<input type="hidden" id="currentPageHidden" th:value="${currentPage ?: 0}">
</body>
</html>