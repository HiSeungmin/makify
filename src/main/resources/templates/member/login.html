<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>로그인 - HabitChallenge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/login.css}" />
    <link rel="icon" type="image/x-icon" th:href="@{/images/favicon.png}">
</head>
<body>

<div class="auth-container">
    <!-- 브랜드 섹션 -->
    <div class="brand-section">
        <h1 class="brand-title">HabitChallenge</h1>
        <p class="brand-subtitle">새로운 습관을 만들어가는 새로운 기회</p>
    </div>

    <!-- 탭 네비게이션 -->
    <div class="auth-tabs">
        <button class="auth-tab active" onclick="showTab('login')">로그인</button>
        <button class="auth-tab" onclick="showTab('signup')">회원가입</button>
    </div>

    <!-- 로그인 폼 -->
    <div id="loginForm" class="form-content">
        <form class="auth-form" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label class="form-label">아이디</label>
                <input type="text" class="form-input" id="loginId" name="loginId" placeholder="아이디를 입력하세요" required>
            </div>

            <div class="form-group">
                <label class="form-label">비밀번호</label>
                <input type="password" class="form-input" id="loginPassword" name="password" placeholder="비밀번호를 입력하세요" required>
            </div>

            <button type="submit" class="auth-button">로그인</button>
        </form>

        <div class="auth-links">
            <a href="#" class="auth-link">아이디 찾기</a>
            <a href="#" class="auth-link">비밀번호 찾기</a>
        </div>

        <!-- 에러 메시지 -->
        <div id="loginError" class="error-message" style="display: none;">
            아이디 또는 비밀번호가 올바르지 않습니다.
        </div>
    </div>

    <!-- 회원가입 폼 -->
    <div id="signupForm" class="form-content" style="display: none;">
        <form class="auth-form" onsubmit="handleSignup(event)">
            <div class="form-group">
                <label class="form-label">이름</label>
                <input type="text" class="form-input" id="signupName" name="name" placeholder="이름을 입력하세요" required>
            </div>

            <div class="form-group">
                <label class="form-label">닉네임</label>
                <input type="text" class="form-input" id="signupNickname" name="nickname" placeholder="닉네임을 입력하세요" required>
            </div>

            <div class="form-group">
                <label class="form-label">이메일</label>
                <input type="email" class="form-input" id="signupEmail" name="email" placeholder="이메일을 입력하세요" required>
            </div>

            <div class="form-group">
                <label class="form-label">아이디</label>
                <input type="text" class="form-input" id="signupLoginId" name="loginId" placeholder="아이디를 입력하세요" required>
            </div>

            <div class="form-group">
                <label class="form-label">비밀번호</label>
                <input type="password" class="form-input" id="signupPassword" name="password" placeholder="비밀번호를 입력하세요" required>
            </div>

            <div class="form-group">
                <label class="form-label">전화번호</label>
                <input type="tel" class="form-input" id="signupPhone" name="phone" placeholder="전화번호를 입력하세요" required>
            </div>

            <button type="submit" class="auth-button">회원가입</button>
        </form>

        <!-- 성공/에러 메시지 -->
        <div id="signupSuccess" class="success-message" style="display: none;">
            회원가입이 완료되었습니다! 로그인해주세요.
        </div>
        <div id="signupError" class="error-message" style="display: none;">
            회원가입 중 오류가 발생했습니다.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 탭 전환 함수
    function showTab(tabName) {
        // 모든 탭에서 active 클래스 제거
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // 클릭된 탭에 active 클래스 추가
        event.target.classList.add('active');

        // 모든 폼 숨기기
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'none';

        // 선택된 폼 보이기
        if (tabName === 'login') {
            document.getElementById('loginForm').style.display = 'block';
        } else {
            document.getElementById('signupForm').style.display = 'block';
        }

        // 에러 메시지 초기화
        hideMessages();
    }

    // 로그인 처리
    async function handleLogin(event) {
        event.preventDefault();
        
        const loginId = document.getElementById('loginId').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ loginId, password })
            });

            if (response.ok) {
                window.location.href = '/';
            } else {
                showLoginError();
            }
        } catch (error) {
            console.error('로그인 오류:', error);
            showLoginError();
        }
    }

    // 회원가입 처리
    async function handleSignup(event) {
        event.preventDefault();
        
        const formData = {
            name: document.getElementById('signupName').value,
            nickname: document.getElementById('signupNickname').value,
            email: document.getElementById('signupEmail').value,
            loginId: document.getElementById('signupLoginId').value,
            password: document.getElementById('signupPassword').value,
            phone: document.getElementById('signupPhone').value
        };

        try {
            const response = await fetch('/auth/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showSignupSuccess();
                // 3초 후 로그인 탭으로 전환
                setTimeout(() => {
                    document.querySelector('.auth-tab').click();
                }, 2000);
            } else {
                const errorData = await response.json();
                showSignupError(errorData.message || '회원가입 중 오류가 발생했습니다.');
            }
        } catch (error) {
            console.error('회원가입 오류:', error);
            showSignupError('회원가입 중 오류가 발생했습니다.');
        }
    }

    // 메시지 표시 함수들
    function showLoginError() {
        document.getElementById('loginError').style.display = 'block';
        setTimeout(() => {
            document.getElementById('loginError').style.display = 'none';
        }, 5000);
    }

    function showSignupSuccess() {
        document.getElementById('signupSuccess').style.display = 'block';
        document.getElementById('signupError').style.display = 'none';
    }

    function showSignupError(message) {
        document.getElementById('signupError').textContent = message;
        document.getElementById('signupError').style.display = 'block';
        document.getElementById('signupSuccess').style.display = 'none';
        setTimeout(() => {
            document.getElementById('signupError').style.display = 'none';
        }, 5000);
    }

    function hideMessages() {
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('signupSuccess').style.display = 'none';
        document.getElementById('signupError').style.display = 'none';
    }

    // 엔터키 처리
    document.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            const activeForm = document.querySelector('.form-content[style*="display: block"], .form-content:not([style*="display: none"])');
            if (activeForm) {
                const submitButton = activeForm.querySelector('.auth-button');
                if (submitButton) {
                    submitButton.click();
                }
            }
        }
    });
</script>
</body>
</html>